---
title: "Titanic - Learning from the Disaster"
author: "Mireia Mora, Jose Antonio Montero"
date: "04/12/2020"
output:
  pdf_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r load_libraries, include=FALSE}
library(knitr)
library(ggplot2)
library(dplyr)
library(caret)
library(tidyverse)
#install.packages("DescTools")
library(DescTools)
```

## __\textcolor{red}{1. Descripció del Dataset }__

### __Lectura de dades.__

En primer lloc, llegiu el fitxer de dades i verifiqueu que els tipus de dades són interpretats correctament. 

Si s’escau, feu les conversions de tipus que siguin oportunes.

```{r 1.Lectura de dades}
#install.packages("stringr")
library(stringr)
## LLegim ele csv amb la sentencia read.csv i fem summary
setwd("D:/UOC_ML/S1-Tipologia i Cicle Vida Dades/PAC/PRAC2")
titanic <- read.csv("train_titanic.csv", dec=".", stringsAsFactors = FALSE)
summary(titanic)
#tipus de cada variable
sapply(titanic,class)
#a few data
head(as.matrix(titanic),3)

#llegim el dataset de test
titanic_test <- read.csv("test_titanic.csv", dec=".", stringsAsFactors = FALSE)
summary(titanic_test)
#tipus de cada variable
sapply(titanic_test,class)
#a few data
head(as.matrix(titanic_test),3)

```

\textcolor{blue}{Descripció del dataset. ¿Per qué és important i quin/es preguntes/problema pretend respondre?}

El dataset del Titanic és un dels més popular en l'anàlisis de dades per l'impacte que va tenir el succés.

Principalment està orientat a __calcular la probabilitat de supervivència dels passatgers en funció de les seves característiques (edat, clase social, preu del passatge, familia, etc)__ però també dona lloc a fer-se preguntes de l'estil __si el preu del passatge dels que sobreviuen és més gran que el preu del passatge dels que moren__, per tant orientarem els nostres anàlisis per a respondre aquest tipus de preguntes.

\newpage

## __\textcolor{red}{2. Integració i selecció de les dades de interés a analitzar }__

En aquest apartat també farem screening i creació de noves variables / discretització.


````{r 2. integracion y seleccion}

#estructura
str(titanic)


#gráficos

#par(mfrow=c(2,2))
par(mfrow=c(3,3))


#1) Boxplot de Price -> quantitativa continua
#boxplot(childseats$Advertising,main="Advertising Box plot", col="gray")


```

\newpage

## __\textcolor{red}{3. Neteja de dades}__

### __3.1 Reducció.__

\textcolor{blue}{Dintre de la neteja de dades una de les opcions és la reducció que consisteix a eliminar variables redundants o que no estan relacionades amb el fet que es vol analitzar.}


```{r 3.1	Reducció - esborrat atributs no necessaris}

##Esborrarem les variables Cabin,Ticket,Name,PassengerId
##Una vegada tiguem calculada la IsAlone també esborrarem Parch,SibSp i FamilySize

titanic = titanic[,!(names(titanic) %in% c("Ticket","Cabin","Name","PassengerId"))]
titanic_test = titanic_test[,!(names(titanic_test) %in% c("Ticket","Cabin","Name","PassengerId"))]

#titanic = titanic[,!(names(titanic) %in% c("Parch","SibSp","FamilySize"))]
#titanic_test = titanic_test[,!(names(titanic_test) %in% c("Parch","SibSp","FamilySize"))]

```


```{r salt a exercici 3.2}

```

### __3.2 Identificació i tractament de valors extrems.__

\textcolor{blue}{Tractament de outliers.} 


```{r 3.2 Outliers}

#crearem grafics boxplot per a cada una de les variables regressores
#que ens interesen


```


### __3.3 Dades perdudes - missing data.__

\textcolor{blue}{Les dades contenen ceros o elements buits? Com gestionaries cadascun d'aquests casos?.}

Anem a evaluar quines variables tenen valors nulls o no informats (amb "") i les 
completarem i discretitzarem si escau.

Ademés, de cara a fer prediccions i sobretot si volem fer regressió logística és adequat que les variables convertides __quedin com a tipus factor__ en R.


```{r 3.3 Missing data}

#
#missing values
#

colSums(is.na(titanic))
#a train tenim bàsicament null values a Age, 177

colSums(titanic=="")
#a train tenim valors perduts no nulls a Cabin i a Embarked

colSums(is.na(titanic_test))
#a train tenim bàsicament null values a Age 86 i 1 a Fare

colSums(titanic_test=="")
#a train tenim valors perduts no nulls a Cabin 

#
# Embarked
#

#Al set de traing tenim 2 missing values que son "", no son pas NA
#Els completem amb el valor més freqüent
#Discretitzem Embarked - convertim Embarked a numeric (0-2 son 3 valors)

#Crearem una funció on passem una columna de dataframe i ens la retorna discretitzada

clean_Embarked <- function (cp) {
  #asignamos los 2 "" el valor més freqüent freq_embarked
  freq_embarked <- tail(names(sort(table(cp))), 1)
  cp[cp==""] <- freq_embarked
  #discretitzem
  cp[cp=='S'] <- 0
  cp[cp=='C'] <- 1
  cp[cp=='Q'] <- 2
  cp<-as.factor(cp)
  return(cp)
}

#Train
titanic %>% count(Embarked)
titanic$Embarked <- clean_Embarked(titanic$Embarked)
titanic %>% count(Embarked)

#Test
titanic_test %>% count(Embarked)
titanic_test$Embarked <- clean_Embarked(titanic_test$Embarked)
titanic_test %>% count(Embarked)

#
# Fare - crearem una nova variable però deixem l'original per a fer un test de hipòtesis posterior
#

#Al set de test tenim 1 NA
#Els completem amb el valor més freqüent
#Discretitzem Fare - creem una rang per Fare de 4 convertim Fare a factor (Q1-Q4 son 4 valors)

clean_Fare <- function (cp) {
  #com a paràmetre rep una columna d'un dataframe que serà l'afectada
  #asignamos els nulls o  "" el valor més freqüent freq_fare
  fare_embarked <- tail(names(sort(table(cp))), 1)
  #cp[cp==""] <- fare_embarked
  cp[is.na(cp)] <- fare_embarked
  #hem de convertit a numeric per poder fer els rangs
  cp <- as.numeric(cp)
  #discretitzem en base a generar un rang de 4 buckets bassat en quartiles
  #la funció CutQ genera els rangs i ja els assigna segons el valor
  fare_quartiles <- CutQ(cp)
  #és una variable tipus factor que assignem a la variable de sortida
  cp <- fare_quartiles
  return(cp)
}

#Train
titanic <- titanic %>%
  mutate(Fare_disc =  clean_Fare(titanic$Fare)
  )
#titanic$Fare <- clean_Fare(titanic$Fare)
titanic %>% count(Fare_disc)

#Test
titanic_test <- titanic_test %>%
  mutate(Fare_disc =  clean_Fare(titanic_test$Fare)
  )
#titanic_test$Fare <- clean_Fare(titanic_test$Fare)
titanic_test %>% count(Fare_disc)

```

Pels cas del missing values de la variable Age anem a fer una mica de tractament especial.

Al tractar-se d'una variable cuantitativa continua ens interessa __omplir el missing values (que no son poc) d'una forma acurada__ i per altre banda, pensant en els anàlisis posteriors __ens interessa discretitzar aquesta variable__. 

Per tant procedirem de la següent manera:

1. predicció de valors fent servir altres features correlades (Age, Sex, Pclass), agafarem per cada combinació de Pclass-Sex la mediana del valor de Age, i aquest serà el que assignarem per a totes les combinacinos de Pclass-Sex que tinguin missing values o NA
2. creem una nova feature AgeBand (5 intervals de edat) 
3. substituim Age per AgeBand
4. finalment podem esborrar la AgeBand

```{r 3.3 Missing data Age}

#creem la función per al tractament de la variable Age

clean_Age <- function (df) {
  #com a paràmetre rebem un data-frame complet perque necessitarem varies columnes
  
  #Necessitem com a pas previ discretitzar la variable Sex
  df$Sex[df$Sex=='male'] <- 0
  df$Sex[df$Sex=='female'] <- 1
  df$Sex<-as.integer(df$Sex)

  #1.matriu pels guessed values de age segons Sex i Pclass
  pred_age <- matrix(nrow = 3, ncol = 2)
  #2.càlcul de les medianes per a cada combinació de Pclass (i) 
  for(i in 1:3) {
    for(j in 1:2) { 
      df_ages <- subset(df,Pclass==i & Sex==j-1)
      pred_age[i,j]  <- median(df_ages$Age,na.rm=T)
      }
  }
  #3.canviem els NA per a cada combinació de Pclass i Sex pel valor que hem calculat abans
  for(i in 1:3) {
    for(j in 1:2) { 
      df$Age[is.na(df$Age) & df$Pclass ==i & df$Sex == j-1] <- pred_age[i,j] 
    }
  }
  
  #4.Creem els intervals de Age
  df$Age_grouping <- cut(df$Age, breaks=c(0,16,32,48,64,100,140), right = FALSE, labels = FALSE)
  #5.Assignem els intervals com a valor de Age
  df$Age <- df$Age_grouping
  #6.Esborrem la variable intermitja Age_grouping
  df = df[,!(names(df) %in% c("Age_grouping"))]
  
  return(df)
}

#Train
titanic <- clean_Age(titanic)
titanic %>% count(Age)
head(titanic)

#Test
titanic_test <- clean_Age(titanic_test)
titanic_test %>% count(Age)
head(titanic_test)


```
  

\newpage

```{r salt a exercici 4}


```

## __\textcolor{red}{4. Anàlisis de de les dades }__

### __4.1 Selecció de dades.__

\textcolor{blue}{Selecció dels grups de dades que es volen analitzar/comparar (planificació dels anàlisis a aplicar).}

Els grups els tenim clarament identificats en el sentit de que farem servir el cojunt de train (titanic) per a generar els models, i el conjunt de test (titanic_test) per a provar-lo o ajustar-lo, i obtenir la seva bondat (accuracy).

Per centrant-nos en els diferents tipus d'anàlisis i en concret si volem fer un contrast de hipótesis per a validar si la mija dels preus (fare) dels que sobreviuen és més gran i igual que la dels que moren, crearem dos grups entorn a la variable preu : els preus dels que sobreviuen i els preus dels que moren

```{r 4.1 Seleccion de dades }

fare_vius = titanic$Fare[titanic$Survived==1]
fare_morts = titanic$Fare[titanic$Survived==0]

```

### __4.2 Comprovació de la normalitat i homegeneitat de la variança.__

Farem inicialment aquestes comprovacions per la variable Fare que és la que voldrem involucrar en el contrast de hipòtesis.

Per la comprovació de normalitat ho farem de manera visual fent servir la funció qnorm

```{r 4.2.1 Comprovacio normalitat }

#1) Diagrama de punts de fare_vius i fare_morts
par(mfrow=c(1,2))

qqnorm(fare_vius,main="Fare survived distribution");qqline(fare_vius, col = 2,lwd=2,lty=2)

qqnorm(fare_morts,main="Fare survived distribution");qqline(fare_morts, col = 2,lwd=2,lty=2)

```

Encara que tenim força punts fora de la línea recta podriem dir que la majora s'agrupen al voltat d'ella per tant donarem per supossat el factor de normalitat, encara que amb dubtes. Amb un conjunt de dades gran podriem arrivar a assumir el factor de normalitat però amb només 891 observaciones aquesta afirmació queda en entredit. De totes formes farem el contrast supossant normalitat.

Per la comprovació de la homocedasticitat podem fer servir la funció var.test de R.

```{r 4.2.2 Comprovacio variança }

#Comprovem homocedasticitat - variances iguals
var.test(x = fare_vius,y = fare_morts)

```

De la sortida de var.test podem veure que __el ratio of variances que és de 4.50 està dintre del interval de confiança de 95\%__, per tant el test no troba diferencies significatives entre les variances d'ambdos grups.

### __4.3 Aplicació proves estadístiques.__

\textcolor{blue}{Aplicació de proves estadístiques per a comparar els grups de dades. En funció de les dades i l'objectiu de l'estudi, aplicar proves de contrast de hipòtesis,
correlacions, regressions, etc. Aplicar almenys 3 mètodes d'anàlisis diferents.}

### __4.3.1 Contrastos de hipotesis.__

Podem acceptar que el preu del passatge (Fare) és més gran en els que sobreviuen que en els que moren? Validarem aquest fet amb un contrast de hipòtesis per a la diferència de 2 mitjanes amb els suposits de normalitat i homocedasticitat, és a dir, aplicarem una t de Student.

La hipòtesi nul.la H0 seria establir que __la mitjana de preus del passatge dels que sobreviuen es igual a la dels que no sobreviuen.__

\textcolor{blue}{H0 : mean(Fare sobreviuen) = mean(Fare moren)}
        
        ó
        
\textcolor{blue}{H0 : mean(Fare sobreviuen) - mean(Fare moren) =  0}

La hipòtesi alternativa H1 representa que s'ha produit algun canvi respecte la situació descrita per la hipòtesis nul.la. En aquest cas establirem el fet que realment volem comprovar al final, que la mitjana del preu del passatge del que sobreviuen és més gran que la dels que moren (és un contrast unilateral per la dreta).

\textcolor{red}{H1 : mean(Fare sobreviuen) > mean(Fare moren)}
        
        ó 
        
\textcolor{red}{H1 : mean(Fare sobreviuen) - mean(Fare moren) > 0}

Encara que podem utilitzar directament la funció t.test de R ens farem una funció propia que ens implementi el càlcul del nostre contrast


```{r 4.3.1 Contrastos de hipotesis}

#Contruim una funció que ens faci el contrast de la diferencia de 
#mitjanes de 2 mostres en mode unilateral dret

contrast_dif_mitjana_2_mostres <- function (p_mostra1,p_mostra2, p_alfa,p_tipus) {
  
  #p_mostra1 és la mostra 1
  #p_mostra2 és la mostra 2
  #p_alfa és el nivell de significació
  
  #H0 : mean(p_mostra1) - mean(p_mostra2) = 0 - hipòtesis nul.la
  #H1 : mean(p_mostra1) - mean(p_mostra2) > 0 - hipòtesis alternativa

  #Calculem tamany,mitjanes i desviacions típiques d'ambues mostres  
  n_us = length(p_mostra1)                
  n_nous = length(p_mostra2)                

  mean_us = mean(p_mostra1)
  mean_nous = mean(p_mostra2)

  dev_tipica_us = sqrt(sum((p_mostra1-mean_us)^2)/(n_us-1))
  dev_tipica_nous = sqrt(sum((p_mostra2-mean_nous)^2)/(n_nous-1))

  #calculem estadístic t
  #ditribució t-student amb n_us+n_nous - 2 graus de llibertat (398)

  s = sqrt(((n_us-1)*dev_tipica_us^2+((n_nous-1)*dev_tipica_nous^2))/(n_us+n_nous-2))

  s_error_std = s * sqrt((1/n_us)+(1/n_nous))
  
  t = (mean_us - mean_nous) / s_error_std
  
  #i finalment el p-value tenint en compte la distribució de t
  #i la hipotesis alternativa
  p_valor = case_when (p_tipus == 'uniesquerra' ~ pt(t,n_us+n_nous-2),
                       p_tipus == 'unidreta' ~ pt(-t,n_us+n_nous-2),
                       p_tipus == 'bidireccional' ~ 2*pt(t,n_us+n_nous-2)
                       )
    
  #si p_value >= nivell de significació p_alfa, acceptarem la H0
  #si p_value < nivell de significació p_alfa, rebutjarem la H0
  
  
  if (p_valor >= p_alfa) {
    ic = c(t,p_valor,'Acceptem Hipòtesi nul.la')
  }
  else
  {
    ic = c(t,p_valor,'Rebutgem Hipòtesi nul.la')
  }
    
  return(ic)
  
}

c_mitjanes = contrast_dif_mitjana_2_mostres(fare_vius,fare_morts,0.5,'unidreta')
c_mitjanes
#[1] t(estadístic) = "7.93919166087105"         p_valor = "3.06009467096209e-15"    
#[3] Resultat : "Rebutgem Hipòtesi nul.la"

#el p_value es pot dir que és infim i per tant més petit que 0.05 així que rebutjariem 
#la Hipotesis nul.la


#Comprovació amb t_test
t.test( fare_vius, fare_morts, # dues mostres 
        alternative = "greater", # contraste per resta de mitjanes
        paired = FALSE, # muestras independientes
        var.equal = TRUE,  # se supone homocedasticidad
        conf.level=0.95)


```

#### __4.3.1.1 Interpretar contratos de hipotesis.__

Com el __p-value (3.06e-15, que és la probabilitat del resultat del estadístic t quan la hipòtesis nul.la és certa) és més PETIT que el nivell d'acceptació (0,05) llavors REBUTGEM la Hipòtesis nul.la__ per tant això vol dir que confirmem que els preus del passatges del que sobreviuen és més gran el preu dels que moren.

Per una altre banda, la sortida de la funció t.test ens està dient que __el p_value NO està dintre de l'interval d'acceptació de la hipòtesi nul.la__, per tant ens porta a rebutjar-la.

Així mateix, el fet de que __l'estadístic de contrast sigui gran (7.9392)__ fa que estigui allunyat del cero (zona on la distribució normal estàndard concentra una probabilitat més gran), per tant __poc probable sota la hipòtesis nul.la.__ El fet d'haver plantejar una hipòtesi alternativa unilateral per la dreta fa també que aquest fet de tenir un valor positiu per l'estadístic de contrast, aquest sigui més probable sota la alternativa.


```{r 4.3.2 Correlacions}


```

#### __4.3.1.2 Interpretar correlacions.__


```{r 4.3.3 Regressio Logaritmica}


```

#### __4.3.1.3. Interpretar regressió logaritmica__


```{r 4.3.4 Altres models}


```

#### __4.3.1.4. Interpretar altres models__

\newpage


```{r salt a Visualitzacio}

```

## __\textcolor{red}{5. Visualització}__

\textcolor{blue}{Representació dels resultats a partir de taules i gràfiques.}


```{r 5.Visualitzacio}

titanic %>% count(Sex)
# 0 - Male, 1 - Female

#Survived by Sex
ggplot(titanic,aes(x=Survived, fill=Sex))+
  geom_histogram(stat = "count")+
  labs(x = "Survival vs Sex")

#Survived by Fare Discretized
ggplot(titanic,aes(x=Survived, fill=Fare_disc))+
  geom_histogram(stat = "count")+
  labs(x = "Survival vs Fare")


```

El gràfic amb les franges/banding de Fare ens diu clarament que dels que sobreviuen (dreta) la majora estan a les franges altes de preu de passatge, aspecte contrari dels que NO sobreviuen.

\newpage

```{r Conclussions}

```

## __\textcolor{red}{6. Conclussions}__

\textcolor{blue}{Resolució del problema. A partir dels resultats obtinguts ¿quines son les conclussions? ¿els resultats permeten respondre el problema?}

1. Sobre la pregunta sobre si el preu del passatge dels que sobreviuen és més gran que el preu dels que moren hem plantejat el següent contrants de hipòtesis

$$
\left\{
\begin{array}{ll}
H_{0}: &  \mu_0(Fare sobreviuen ) - \mu_1(Fare moren) = 0\\
H_{1}: & \mu_0(Fare sobreviuen) - \mu_1(Fare moren) > 0
\end{array}
\right.
$$

a on establint un nivell de significació de 0.05 __el p_value obtingut és ínfim i per tant més petit que 0.05, així que REBUTGEM la H0__, i això vol dir en que estem d'acord amb el postulat de la hipòtesis alternativa pel que fa al preu del passatge dels que sobreviuen és més gran que el preu dels que moren.

